# 需求文档：分布式工作流引擎架构重构

## 简介

当前工作流引擎虽然运行在Pekko Cluster之上，但工作流执行本质上是单机的。所有节点在同一个JVM进程中通过Pekko Stream串行执行，无法利用集群的分布式能力。本需求旨在将工作流引擎重构为真正的分布式架构。

## 术语表

- **Workflow**: 工作流，由多个节点（Node）和边（Edge）组成的有向无环图（DAG）
- **WorkflowActor**: 代表单个工作流实例的Actor
- **Node**: 工作流中的单个处理单元（Source/Transform/Sink）
- **Cluster Sharding**: Pekko提供的分布式Actor分片机制
- **Entity**: Cluster Sharding中的实体，每个WorkflowActor是一个Entity
- **Shard**: 分片，多个Entity的集合，分布在不同节点
- **ShardRegion**: 分片区域，管理本节点上的所有Shard

## 需求

### 需求 1：工作流实例分布式部署

**用户故事**：作为系统管理员，我希望工作流实例能够自动分布到集群的多个节点上，以便充分利用集群资源并提高系统吞吐量。

#### 验收标准

1. WHEN 创建新的工作流实例 THEN 系统应该根据分片策略将WorkflowActor分配到集群中的某个节点
2. WHEN 集群有多个节点 THEN 工作流实例应该均匀分布在这些节点上
3. WHEN 查询工作流状态 THEN 系统应该能够透明地路由到正确的节点并返回结果
4. WHEN 执行工作流 THEN 系统应该能够透明地路由到正确的节点并触发执行
5. WHEN 集群节点数量变化 THEN 系统应该自动重新平衡工作流实例的分布

### 需求 2：节点故障自动恢复

**用户故事**：作为系统运维人员，我希望当某个集群节点宕机时，该节点上的工作流实例能够自动迁移到其他健康节点，确保服务不中断。

#### 验收标准

1. WHEN 运行工作流的节点宕机 THEN 系统应该在其他节点上重新启动该WorkflowActor
2. WHEN WorkflowActor重启 THEN 系统应该从Event Sourcing恢复工作流状态
3. WHEN 节点恢复 THEN 系统应该能够重新接受工作流实例的分配
4. WHEN 发生故障转移 THEN 正在执行的工作流应该能够从上次检查点继续执行
5. WHEN 故障转移完成 THEN 客户端请求应该能够透明地路由到新节点

### 需求 3：分片策略配置

**用户故事**：作为系统架构师，我希望能够配置工作流实例的分片策略，以便根据业务特点优化资源利用和性能。

#### 验收标准

1. WHEN 配置分片数量 THEN 系统应该创建指定数量的Shard
2. WHEN 配置分片策略为哈希 THEN 系统应该根据workflowId的哈希值分配Shard
3. WHEN 配置分片策略为自定义 THEN 系统应该支持自定义的分片逻辑
4. WHEN 分片策略变更 THEN 系统应该能够平滑地重新分配工作流实例
5. WHEN 查询分片信息 THEN 系统应该能够返回每个Shard的位置和包含的Entity数量

### 需求 4：工作流路由透明性

**用户故事**：作为API开发者，我希望调用工作流API时不需要关心工作流实例在哪个节点上，系统能够自动路由到正确的节点。

#### 验收标准

1. WHEN 通过HTTP API创建工作流 THEN 系统应该自动将请求路由到负责该工作流的节点
2. WHEN 通过HTTP API执行工作流 THEN 系统应该自动将请求路由到负责该工作流的节点
3. WHEN 通过HTTP API查询工作流状态 THEN 系统应该自动将请求路由到负责该工作流的节点
4. WHEN 工作流实例迁移到其他节点 THEN 后续请求应该自动路由到新节点
5. WHEN 目标节点不可达 THEN 系统应该返回明确的错误信息而不是超时

### 需求 5：负载均衡和资源隔离

**用户故事**：作为系统管理员，我希望工作流实例能够根据负载情况自动分配到不同节点，避免某些节点过载而其他节点空闲。

#### 验收标准

1. WHEN 创建大量工作流实例 THEN 系统应该将它们均匀分布到所有可用节点
2. WHEN 某个节点负载过高 THEN 新的工作流实例应该优先分配到负载较低的节点
3. WHEN 工作流实例消耗大量资源 THEN 系统应该能够隔离其影响，不影响其他工作流
4. WHEN 节点资源不足 THEN 系统应该拒绝新的工作流实例创建并返回明确错误
5. WHEN 查询集群负载 THEN 系统应该能够返回每个节点的工作流实例数量和资源使用情况

### 需求 6：分布式监控和可观测性

**用户故事**：作为系统运维人员，我希望能够监控工作流实例在集群中的分布情况，以便及时发现和解决问题。

#### 验收标准

1. WHEN 查询集群状态 THEN 系统应该返回每个节点上的工作流实例数量
2. WHEN 查询Shard分布 THEN 系统应该返回每个Shard所在的节点和包含的Entity列表
3. WHEN 工作流实例迁移 THEN 系统应该记录迁移事件和原因
4. WHEN 发生分片再平衡 THEN 系统应该记录再平衡的开始和结束时间
5. WHEN 查询工作流位置 THEN 系统应该能够返回指定工作流实例所在的节点

### 需求 7：向后兼容性

**用户故事**：作为系统维护者，我希望架构重构不会破坏现有的API和功能，确保平滑升级。

#### 验收标准

1. WHEN 使用现有的HTTP API THEN 所有接口应该保持兼容
2. WHEN 使用现有的WorkflowDSL THEN 工作流定义格式应该保持不变
3. WHEN 查询Event Sourcing历史 THEN 历史数据应该能够正常读取
4. WHEN 从旧版本升级 THEN 系统应该能够自动迁移现有的工作流实例
5. WHEN 回滚到旧版本 THEN 系统应该能够正常运行（在合理范围内）

### 需求 8：性能和可扩展性

**用户故事**：作为系统架构师，我希望分布式架构能够显著提升系统的性能和可扩展性，支持更大规模的工作流并发执行。

#### 验收标准

1. WHEN 集群有N个节点 THEN 系统吞吐量应该接近N倍单节点吞吐量
2. WHEN 并发执行1000个工作流 THEN 系统应该能够稳定运行不崩溃
3. WHEN 工作流实例数量增加 THEN 单个工作流的执行延迟不应该显著增加
4. WHEN 添加新节点 THEN 系统应该能够自动利用新节点的资源
5. WHEN 移除节点 THEN 系统应该能够平滑地迁移工作流实例而不丢失数据

## 非功能性需求

### 性能要求

- 工作流创建延迟：< 100ms (P99)
- 工作流执行触发延迟：< 50ms (P99)
- 状态查询延迟：< 20ms (P99)
- 故障转移时间：< 5秒
- 分片再平衡时间：< 30秒（1000个工作流实例）

### 可靠性要求

- 系统可用性：99.9%
- 数据持久性：100%（通过Event Sourcing保证）
- 故障恢复成功率：> 99%

### 可扩展性要求

- 支持集群节点数：3-100个节点
- 支持工作流实例数：10,000+
- 支持并发执行数：1,000+

## 约束条件

1. 必须使用Pekko Cluster Sharding，不引入其他分布式框架
2. 必须保持Event Sourcing机制，确保数据不丢失
3. 必须保持现有的HTTP API接口不变
4. 必须支持JDK 11+
5. 必须在现有的Scala 2.13代码库上实现

## 依赖关系

- 依赖现有的Pekko Cluster基础设施
- 依赖现有的Event Sourcing实现
- 依赖现有的WorkflowDSL定义
- 依赖现有的HTTP API框架

## 风险和假设

### 风险

1. **性能风险**：Cluster Sharding可能引入额外的网络延迟
2. **复杂性风险**：分布式系统的调试和运维复杂度增加
3. **兼容性风险**：可能与现有的某些功能不兼容

### 假设

1. 假设集群网络延迟 < 10ms
2. 假设节点故障率 < 1%
3. 假设工作流实例的生命周期足够长，值得分布式管理

## 成功标准

1. 所有验收标准通过
2. 性能测试达到预期指标
3. 在3节点集群上稳定运行7天无故障
4. 代码审查通过，无重大技术债务
