# DataFusion Kubernetes环境配置
# 
# 此配置专为K8s环境设计，使用服务发现和环境变量

include "datafusion.conf"

datafusion {
  enabled = true
  
  # K8s环境使用服务名进行服务发现
  host = "datafusion-service"  # K8s Service名称
  host = ${?DATAFUSION_SERVICE_HOST}
  
  port = 50051
  port = ${?DATAFUSION_SERVICE_PORT}
  
  pool {
    # K8s环境适当增加连接数
    maxTotal = 15
    maxTotal = ${?DATAFUSION_POOL_MAX_TOTAL}
    
    maxIdle = 8
    maxIdle = ${?DATAFUSION_POOL_MAX_IDLE}
    
    minIdle = 3
    minIdle = ${?DATAFUSION_POOL_MIN_IDLE}
    
    # K8s环境网络延迟可能更高
    connectTimeout = 10000
    connectTimeout = ${?DATAFUSION_POOL_CONNECT_TIMEOUT}
    
    requestTimeout = 45000
    requestTimeout = ${?DATAFUSION_POOL_REQUEST_TIMEOUT}
  }
  
  query {
    defaultBatchSize = 1000
    defaultBatchSize = ${?DATAFUSION_QUERY_DEFAULT_BATCH_SIZE}
    
    defaultTimeout = 45
    defaultTimeout = ${?DATAFUSION_QUERY_DEFAULT_TIMEOUT}
    
    maxRetries = 3
    maxRetries = ${?DATAFUSION_QUERY_MAX_RETRIES}
    
    retryDelay = 2000  # K8s环境稍长的重试延迟
    retryDelay = ${?DATAFUSION_QUERY_RETRY_DELAY}
  }
  
  monitoring {
    metricsEnabled = true
    metricsEnabled = ${?DATAFUSION_METRICS_ENABLED}
    
    structuredLogging = true
    structuredLogging = ${?DATAFUSION_STRUCTURED_LOGGING}
    
    slowQueryThreshold = 8000  # K8s环境考虑网络延迟
    slowQueryThreshold = ${?DATAFUSION_SLOW_QUERY_THRESHOLD}
  }
  
  healthCheck {
    interval = 30
    interval = ${?DATAFUSION_HEALTH_CHECK_INTERVAL}
    
    timeout = 8000  # K8s环境更长的健康检查超时
    timeout = ${?DATAFUSION_HEALTH_CHECK_TIMEOUT}
    
    failureThreshold = 3
    failureThreshold = ${?DATAFUSION_HEALTH_CHECK_FAILURE_THRESHOLD}
  }
}