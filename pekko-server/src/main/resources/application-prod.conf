# 生产环境配置
# 使用方式: -Dconfig.resource=application-prod.conf

include "application.conf"

pekko {
  # 生产环境系统名称
  pekko-sys = "pekko-cluster-system-prod"
  
  # 集群配置
  cluster {
    # 生产环境种子节点（从环境变量读取）
    seed-nodes = ${?PEKKO_SEED_NODES}
    seed-nodes = [
      "pekko://pekko-cluster-system-prod@node1:2551",
      "pekko://pekko-cluster-system-prod@node2:2551",
      "pekko://pekko-cluster-system-prod@node3:2551"
    ]
    
    # 生产环境角色（从环境变量读取）
    roles = ${?PEKKO_ROLES}
    roles = ["worker"]
    
    # 生产环境故障检测器配置
    failure-detector {
      acceptable-heartbeat-pause = 5s
      threshold = 12.0
    }
    
    # 生产环境禁用自动downing（使用Split Brain Resolver）
    auto-down-unreachable-after = off
    
    # Split Brain Resolver配置
    downing-provider-class = "org.apache.pekko.cluster.sbr.SplitBrainResolverProvider"
    split-brain-resolver {
      active-strategy = "keep-majority"
      stable-after = 20s
    }
    
    # 最小成员数要求
    min-nr-of-members = 3
    
    # Cluster Sharding配置
    sharding {
      # 生产环境使用更多的分片
      number-of-shards = ${?PEKKO_SHARDING_SHARDS}
      number-of-shards = 100
      
      # 角色限制
      role = "worker"
      
      # 生产环境较长的Passivation时间
      passivate-idle-entity-after = 1h
      
      # Remember Entities
      remember-entities = on
      remember-entities-store = "eventsourced"
      
      # 生产环境再平衡配置
      rebalance-interval = 30s
      least-shard-allocation-strategy {
        rebalance-threshold = 5
        max-simultaneous-rebalance = 3
      }
      
      # 较长的超时时间
      waiting-for-state-timeout = 10s
      updating-state-timeout = 10s
    }
  }
  
  # 远程配置
  remote {
    artery {
      canonical {
        # 从环境变量读取
        hostname = ${?PEKKO_HOSTNAME}
        hostname = "0.0.0.0"
        port = ${?PEKKO_PORT}
        port = 2551
      }
      
      # 生产环境高级配置
      advanced {
        # 最大帧大小
        maximum-frame-size = 256 KiB
        # 缓冲池大小
        buffer-pool-size = 128
        # 最大并发流数
        maximum-large-frame-size = 2 MiB
      }
    }
  }
  
  # 生产环境持久化配置（使用Cassandra或PostgreSQL）
  persistence {
    journal {
      # 生产环境建议使用Cassandra
      plugin = ${?PEKKO_PERSISTENCE_JOURNAL_PLUGIN}
      plugin = "pekko.persistence.journal.leveldb"
      
      leveldb {
        dir = ${?PEKKO_PERSISTENCE_JOURNAL_DIR}
        dir = "/var/lib/pekko/journal"
        native = true
      }
    }
    
    snapshot-store {
      plugin = ${?PEKKO_PERSISTENCE_SNAPSHOT_PLUGIN}
      plugin = "pekko.persistence.snapshot-store.local"
      
      local {
        dir = ${?PEKKO_PERSISTENCE_SNAPSHOT_DIR}
        dir = "/var/lib/pekko/snapshots"
      }
    }
  }
  
  # 工作流事件溯源配置
  workflow {
    event-sourcing {
      # 生产环境快照频率
      snapshot-every = ${?PEKKO_WORKFLOW_SNAPSHOT_EVERY}
      snapshot-every = 100
      
      # 保留快照数量
      keep-n-snapshots = ${?PEKKO_WORKFLOW_KEEP_SNAPSHOTS}
      keep-n-snapshots = 3
    }
  }
  
  # 日志配置（生产环境）
  loglevel = ${?PEKKO_LOG_LEVEL}
  loglevel = "INFO"
  
  stdout-loglevel = "INFO"
  
  # 生产环境日志配置
  loggers = ["org.apache.pekko.event.slf4j.Slf4jLogger"]
  logging-filter = "org.apache.pekko.event.slf4j.Slf4jLoggingFilter"
  
  # 日志死信
  log-dead-letters = 10
  log-dead-letters-during-shutdown = off
}

# HTTP服务器配置
http {
  host = ${?HTTP_HOST}
  host = "0.0.0.0"
  
  port = ${?HTTP_PORT}
  port = 8080
  
  # 请求超时
  request-timeout = 30s
  
  # 绑定超时
  bind-timeout = 5s
}
